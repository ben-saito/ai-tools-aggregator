---
import Layout from '../../layouts/Layout.astro';
import { getLangFromUrl } from '../../lib/i18n';
import { supabase } from '../../lib/supabase';
import QuizFlow from '../../components/quiz/QuizFlow';

export const prerender = false;

const lang = getLangFromUrl(Astro.url) as 'en' | 'ja';

// Get total diagnosis count from Supabase
const { count, error } = await supabase
  .from('quiz_results')
  .select('*', { count: 'exact', head: true });

const diagnosisCount = count || 0;

// Format diagnosis count for display
function formatCount(num: number): string {
  if (num >= 1000) {
    return `${Math.floor(num / 1000)},${String(num % 1000).padStart(3, '0')}`;
  }
  return String(num);
}

const formattedCount = formatCount(diagnosisCount);

const texts = {
  en: {
    title: 'AI Tool Finder Quiz | Find Your Perfect AI Tool',
    description: 'Answer 5 simple questions to find the best AI tools tailored to your needs. Join 10,000+ others!',
    badge: diagnosisCount > 0 ? `${formattedCount}+ people diagnosed` : '10,000+ people diagnosed',
    heading1: 'Find Your Perfect',
    headingHighlight: 'AI Tool',
    subheading: 'Overwhelmed by thousands of AI tools? Answer 5 quick questions and our algorithm will recommend the best ones for your specific needs, budget, and skill level.',
    footer: 'Takes less than 1 minute \u2022 Free forever \u2022 No login required',
  },
  ja: {
    title: 'AIツール診断 | あなたに最適なAIツールを見つけよう',
    description: '5つの質問に答えるだけで、あなたに最適なAIツールを診断します。10,000人以上が診断済み！',
    badge: diagnosisCount > 0 ? `${formattedCount}人以上が診断済み` : '10,000人以上が診断済み',
    heading1: 'あなたに最適な',
    headingHighlight: 'AIツール',
    subheading: '数千のAIツールの中から、たった5つの質問であなたのニーズ、予算、スキルレベルに最適なツールをおすすめします。',
    footer: '約1分で完了 \u2022 完全無料 \u2022 ログイン不要',
  },
};

const t = texts[lang];
---

<Layout title={t.title} description={t.description}>
  <div class="min-h-screen bg-gradient-to-b from-primary-50 to-white py-12 md:py-20">
    <div class="container mx-auto px-4 text-center">

      {/* Hero Section */}
      <div class="mb-12 space-y-4">
        <span class="inline-block rounded-full bg-primary-100 px-4 py-1.5 text-sm font-semibold text-primary-700">
          {t.badge}
        </span>
        <h1 class="text-4xl font-extrabold tracking-tight text-[var(--color-text-primary)] md:text-6xl">
          {t.heading1} <span class="bg-gradient-to-r from-primary-600 to-indigo-600 box-decoration-clone bg-clip-text text-transparent">{t.headingHighlight}</span>
        </h1>
        <p class="mx-auto max-w-2xl text-lg text-[var(--color-text-secondary)] md:text-xl">
          {t.subheading}
        </p>
      </div>

      {/* Quiz Application */}
      <div class="mx-auto max-w-3xl">
        <QuizFlow lang={lang} client:load />
      </div>

      {/* Social Proof / Footer */}
      <div class="mt-12 text-sm text-[var(--color-text-tertiary)]">
        <p>{t.footer}</p>
      </div>

    </div>
  </div>
</Layout>
