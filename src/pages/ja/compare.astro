---
import Layout from '../../layouts/Layout.astro';
import { getToolById } from '../../lib/tools';
import type { Tool } from '../../lib/types';
import { getLangFromUrl, useTranslations } from '../../lib/i18n';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

export const prerender = false;

const toolsParam = Astro.url.searchParams.get('tools');
const toolIds = toolsParam ? toolsParam.split(',') : [];

const tools: Tool[] = toolIds
  .map(id => getToolById(id))
  .filter((tool): tool is Tool => !!tool);

const hasTools = tools.length > 0;
---

<Layout title={t('compare.title')} description={t('compare.description')}>
  <main class="mx-auto max-w-7xl px-4 py-12 sm:px-6 lg:px-8">
    <div class="mb-8">
      <a href="/ja" class="mb-4 inline-flex items-center text-sm text-[var(--color-text-tertiary)] hover:text-[var(--color-text-secondary)]">
        <svg class="mr-2 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
        </svg>
        {t('compare.backToTools')}
      </a>
      <h1 class="text-3xl font-bold text-[var(--color-text-primary)]">{t('compare.pageTitle')}</h1>
      <p class="mt-2 text-[var(--color-text-secondary)]">{t('compare.subtitle')}</p>
    </div>

    {!hasTools ? (
      <div class="rounded-lg border-2 border-dashed border-[var(--color-border-primary)] p-12 text-center">
        <svg class="mx-auto h-12 w-12 text-[var(--color-text-tertiary)]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
        </svg>
        <h3 class="mt-2 text-sm font-medium text-[var(--color-text-primary)]">{t('compare.noTools')}</h3>
        <p class="mt-1 text-sm text-[var(--color-text-tertiary)]">{t('compare.noToolsDesc')}</p>
        <div class="mt-6">
          <a href="/ja" class="inline-flex items-center rounded-md border border-transparent bg-primary-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-primary-700">
            {t('compare.browseTools')}
          </a>
        </div>
      </div>
    ) : (
      <div class="overflow-hidden rounded-lg border border-[var(--color-border-primary)] bg-[var(--color-bg-elevated)] shadow">
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-[var(--color-border-primary)]">
            <thead class="bg-[var(--color-bg-secondary)]">
              <tr>
                <th scope="col" class="px-6 py-4 text-left text-sm font-medium text-[var(--color-text-tertiary)] w-1/4">{t('compare.feature')}</th>
                {tools.map(tool => (
                  <th scope="col" class="px-6 py-4 text-left text-sm font-medium text-[var(--color-text-primary)] w-1/4 relative group">
                     {/* Remove button */}
                     <button
                        data-remove-tool={tool.id}
                        class="absolute top-2 right-2 text-[var(--color-text-tertiary)] hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"
                        title="Remove from comparison"
                     >
                       <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                       </svg>
                     </button>

                    <div class="flex flex-col items-center">
                      <img src={tool.logoUrl || '/placeholder.png'} alt={tool.name} class="mb-3 h-12 w-12 rounded object-contain" />
                      <a href={`/tools/${tool.id}`} class="text-lg font-bold hover:text-primary-600">{tool.name}</a>
                    </div>
                  </th>
                ))}
                {/* Fill empty columns if less than 3 */}
                {Array.from({ length: 3 - tools.length }).map(() => (
                   <th scope="col" class="px-6 py-4 text-center text-sm font-medium text-[var(--color-text-tertiary)] border-l border-dashed w-1/4">
                     <div class="flex flex-col items-center justify-center h-full min-h-[100px]">
                        <span class="mb-2">Empty Slot</span>
                        <a href="/" class="text-xs text-primary-600 hover:underline">Add Tool</a>
                     </div>
                   </th>
                ))}
              </tr>
            </thead>
            <tbody class="divide-y divide-[var(--color-border-primary)] bg-[var(--color-bg-elevated)]">
              {/* Category */}
              <tr>
                <td class="bg-[var(--color-bg-secondary)] px-6 py-4 text-sm font-medium text-[var(--color-text-primary)]">{t('compare.category')}</td>
                {tools.map(tool => (
                  <td class="px-6 py-4 text-sm text-[var(--color-text-tertiary)] text-center">
                    <span class="inline-flex items-center rounded-full bg-[var(--color-bg-tertiary)] px-2.5 py-0.5 text-xs font-medium text-[var(--color-text-primary)]">
                      {tool.category}
                    </span>
                  </td>
                ))}
                {Array.from({ length: 3 - tools.length }).map(() => <td class="px-6 py-4"></td>)}
              </tr>

              {/* Pricing */}
              <tr>
                <td class="bg-[var(--color-bg-secondary)] px-6 py-4 text-sm font-medium text-[var(--color-text-primary)]">{t('compare.pricing')}</td>
                {tools.map(tool => (
                  <td class="px-6 py-4 text-sm text-[var(--color-text-tertiary)] text-center capitalize">{tool.pricing}</td>
                ))}
                {Array.from({ length: 3 - tools.length }).map(() => <td class="px-6 py-4"></td>)}
              </tr>
              
              {/* Description */}
              <tr>
                <td class="bg-[var(--color-bg-secondary)] px-6 py-4 text-sm font-medium text-[var(--color-text-primary)]">{t('compare.description')}</td>
                {tools.map(tool => (
                  <td class="px-6 py-4 text-sm text-[var(--color-text-tertiary)]">{tool.description}</td>
                ))}
                {Array.from({ length: 3 - tools.length }).map(() => <td class="px-6 py-4"></td>)}
              </tr>

              {/* Tags */}
               <tr>
                <td class="bg-[var(--color-bg-secondary)] px-6 py-4 text-sm font-medium text-[var(--color-text-primary)]">Tags</td>
                {tools.map(tool => (
                  <td class="px-6 py-4 text-sm text-[var(--color-text-tertiary)]">
                    <div class="flex flex-wrap justify-center gap-1">
                        {tool.tags.map(tag => (
                            <span class="inline-flex items-center rounded bg-primary-50 px-2 py-0.5 text-xs font-medium text-primary-700">
                                {tag}
                            </span>
                        ))}
                    </div>
                  </td>
                ))}
                {Array.from({ length: 3 - tools.length }).map(() => <td class="px-6 py-4"></td>)}
              </tr>

              {/* Features - Mock data if not present or handle gracefully */}
               <tr>
                <td class="bg-[var(--color-bg-secondary)] px-6 py-4 text-sm font-medium text-[var(--color-text-primary)]">Key Features</td>
                {tools.map(tool => (
                  <td class="px-6 py-4 text-sm text-[var(--color-text-tertiary)]">
                     <ul class="list-disc pl-4 space-y-1 text-left">
                        {/* If features exist in schema utilize them, otherwise mock for now or leave empty */}
                        {tool.features && tool.features.length > 0 ? (
                            tool.features.map(f => <li>{f}</li>)
                        ) : (
                            <li class="text-[var(--color-text-tertiary)] italic">No specific features listed</li>
                        )}
                     </ul>
                  </td>
                ))}
                {Array.from({ length: 3 - tools.length }).map(() => <td class="px-6 py-4"></td>)}
              </tr>

              {/* CTA */}
              <tr>
                <td class="bg-[var(--color-bg-secondary)] px-6 py-4 text-sm font-medium text-[var(--color-text-primary)]"></td>
                {tools.map(tool => (
                  <td class="px-6 py-4 text-center">
                    <a 
                      href={tool.url} 
                      target="_blank" 
                      rel="noopener noreferrer"
                      class="inline-flex items-center justify-center rounded-md border border-transparent bg-primary-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2"
                    >
                      {t('tool.visitWebsite')}
                      <svg class="-mr-1 ml-2 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                      </svg>
                    </a>
                  </td>
                ))}
                {Array.from({ length: 3 - tools.length }).map(() => <td class="px-6 py-4"></td>)}
              </tr>

            </tbody>
          </table>
        </div>
      </div>
    )}
  </main>
</Layout>

<script>
    import { toggleTool, selectedToolsMap } from '../../stores/comparisonStore';

    // Sync URL params to store on load
    const urlParams = new URLSearchParams(window.location.search);
    const toolsParam = urlParams.get('tools');
    if (toolsParam) {
      const toolIds = toolsParam.split(',');
      // Update store to match URL
      // We create a new map
      const newMap: Record<string, string> = {};
      toolIds.forEach(id => newMap[id] = 'true');
      selectedToolsMap.set(newMap);
    }


    // Handle remove buttons
    const removeButtons = document.querySelectorAll('[data-remove-tool]');
    removeButtons.forEach(btn => {
        btn.addEventListener('click', () => {
             const id = btn.getAttribute('data-remove-tool');
             if(id) {
                 // Remove from store
                 toggleTool(id);
                 // Reload page with updated params
                 // We need to read store state to construct new URL, but toggleTool is async/store based.
                 // Actually easier to just get current URL params, remove id, and reload.
                 const url = new URL(window.location.href);
                 const tools = url.searchParams.get('tools')?.split(',') || [];
                 const newTools = tools.filter(t => t !== id);
                 if (newTools.length > 0) {
                     url.searchParams.set('tools', newTools.join(','));
                 } else {
                     url.searchParams.delete('tools');
                 }
                 window.location.href = url.toString();
             }
        });
    });
</script>
