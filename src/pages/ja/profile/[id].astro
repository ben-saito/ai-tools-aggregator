---
import Layout from '../../../layouts/Layout.astro';
import Header from '../../../components/Header.astro';
import { getLangFromUrl, useTranslations } from '../../../lib/i18n';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

export const prerender = false; // Dynamic page for user profiles

const { id } = Astro.params;

// This will be populated with Supabase data
// For now, we'll use placeholder data
const user = {
  id,
  username: t('profile.loading'),
  avatar_url: null,
  is_verified: false,
  auth_provider: null,
  created_at: new Date().toISOString()
};
---

<Layout title={`${user.username} | AI Tools Aggregator`}>
  <Header />
  <main class="mx-auto max-w-5xl px-4 py-8">
    <!-- Profile Header -->
    <div class="mb-8 rounded-xl border border-gray-200 bg-white p-6 shadow-sm">
      <div class="flex items-start gap-4">
        <div class="flex-shrink-0">
          {user.avatar_url ? (
            <img src={user.avatar_url} alt={user.username} class="h-20 w-20 rounded-full" />
          ) : (
            <div class="flex h-20 w-20 items-center justify-center rounded-full bg-primary-100 text-2xl font-bold text-primary-600">
              {user.username[0]?.toUpperCase() || '?'}
            </div>
          )}
        </div>
        <div class="flex-1">
          <div class="flex items-center gap-2">
            <h1 id="profile-username" class="text-2xl font-bold text-gray-900">{t('profile.loading')}</h1>
            {user.is_verified && (
              <svg class="h-6 w-6 text-blue-500" viewBox="0 0 24 24" fill="currentColor">
                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            )}
          </div>
          <p class="mt-1 text-sm text-gray-500">
            {t('profile.memberSince')} <span id="profile-joined">{t('profile.loading')}</span>
          </p>
        </div>
      </div>

      <!-- Stats -->
      <div class="mt-6 grid grid-cols-3 gap-4 border-t border-gray-100 pt-6">
        <div class="text-center">
          <p class="text-2xl font-bold text-gray-900" id="stat-reviews">0</p>
          <p class="text-sm text-gray-500">{t('profile.reviews')}</p>
        </div>
        <div class="text-center">
          <p class="text-2xl font-bold text-gray-900" id="stat-helpful">0</p>
          <p class="text-sm text-gray-500">Helpful Votes</p>
        </div>
        <div class="text-center">
          <p class="text-2xl font-bold text-gray-900" id="stat-upvotes">0</p>
          <p class="text-sm text-gray-500">Upvotes Given</p>
        </div>
      </div>
    </div>

    <!-- Reviews Section -->
    <div class="rounded-xl border border-gray-200 bg-white p-6 shadow-sm">
      <h2 class="mb-4 text-xl font-bold text-gray-900">{t('profile.reviews')}</h2>
      <div id="reviews-list" class="space-y-4">
        <div class="py-8 text-center text-gray-500">
          <p>{t('profile.loading')}...</p>
        </div>
      </div>
    </div>
  </main>
</Layout>

<script define:vars={{ userId: id }}>
  import { supabase } from '../../../lib/supabase';

  async function loadProfile() {
    try {
      // Load user profile
      const { data: profile, error: profileError } = await supabase
        .from('profiles')
        .select('*')
        .eq('id', userId)
        .single();

      if (profileError) {
        console.error('Profile error:', profileError);
        document.getElementById('profile-username').textContent = 'User not found';
        return;
      }

      // Update UI
      document.getElementById('profile-username').textContent = profile.username || 'Anonymous';
      
      const joinedDate = new Date(profile.created_at).toLocaleDateString('en-US', {
        month: 'long',
        year: 'numeric'
      });
      document.getElementById('profile-joined').textContent = joinedDate;

      // Load reviews
      const { data: reviews, error: reviewsError } = await supabase
        .from('reviews')
        .select(`
          *,
          tool:tools(id, name, logo_url, category)
        `)
        .eq('user_id', userId)
        .order('created_at', { ascending: false });

      if (reviewsError) {
        console.error('Reviews error:', reviewsError);
        return;
      }

      // Update stats
      document.getElementById('stat-reviews').textContent = reviews.length.toString();

      // Calculate helpful votes
      const helpfulCount = reviews.reduce((sum, review) => sum + (review.helpful_count || 0), 0);
      document.getElementById('stat-helpful').textContent = helpfulCount.toString();

      // Load upvotes count
      const { count: upvotesCount } = await supabase
        .from('tool_votes')
        .select('*', { count: 'exact', head: true })
        .eq('user_id', userId);

      document.getElementById('stat-upvotes').textContent = upvotesCount?.toString() || '0';

      // Render reviews
      const reviewsList = document.getElementById('reviews-list');
      if (reviews.length === 0) {
        reviewsList.innerHTML = '<div class="py-8 text-center text-gray-500"><p>No reviews yet.</p></div>';
        return;
      }

      reviewsList.innerHTML = reviews.map(review => `
        <div class="rounded-lg border border-gray-100 p-4 hover:border-gray-200">
          <div class="flex items-start gap-3">
            ${review.tool?.logo_url ? 
              `<img src="${review.tool.logo_url}" alt="${review.tool?.name}" class="h-10 w-10 rounded" />` :
              '<div class="h-10 w-10 rounded bg-gray-100"></div>'
            }
            <div class="flex-1">
              <div class="flex items-center justify-between">
                <a href="/tools/${review.tool?.id}" class="font-semibold text-gray-900 hover:text-primary-600">
                  ${review.tool?.name || 'Unknown Tool'}
                </a>
                <div class="flex items-center gap-1">
                  ${Array.from({ length: 5 }, (_, i) => `
                    <svg class="h-4 w-4 ${i < review.rating ? 'text-yellow-400' : 'text-gray-300'}" fill="currentColor" viewBox="0 0 20 20">
                      <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                    </svg>
                  `).join('')}
                </div>
              </div>
              <p class="mt-2 text-sm text-gray-700">${review.content}</p>
              <p class="mt-2 text-xs text-gray-500">
                ${new Date(review.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
                Â· ${review.helpful_count || 0} found this helpful
              </p>
            </div>
          </div>
        </div>
      `).join('');

    } catch (error) {
      console.error('Error loading profile:', error);
    }
  }

  // Wait for Supabase to be ready
  if (window.__supabaseReady) {
    loadProfile();
  } else {
    window.addEventListener('supabase-ready', loadProfile);
  }
</script>
