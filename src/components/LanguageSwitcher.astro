---
import { languages, getLangFromUrl, getLocalizedPath, removeLocalePath, type Language } from '../lib/i18n';

const currentPath = Astro.url.pathname;
const currentLang = getLangFromUrl(Astro.url);
const basePath = removeLocalePath(currentPath);
---

<div class="relative inline-block text-left">
  <button
    type="button"
    class="inline-flex items-center justify-center gap-2 px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
    id="language-menu-button"
    aria-expanded="false"
    aria-haspopup="true"
  >
    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129" />
    </svg>
    <span>{languages[currentLang]}</span>
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
    </svg>
  </button>

  <div
    class="origin-top-right absolute right-0 mt-2 w-40 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 divide-y divide-gray-100 focus:outline-none hidden"
    id="language-menu"
    role="menu"
    aria-orientation="vertical"
    aria-labelledby="language-menu-button"
  >
    <div class="py-1" role="none">
      {Object.entries(languages).map(([lang, label]) => (
        <a
          href={getLocalizedPath(basePath, lang as Language)}
          class={`block px-4 py-2 text-sm ${
            lang === currentLang
              ? 'bg-blue-50 text-blue-700 font-semibold'
              : 'text-gray-700 hover:bg-gray-100 hover:text-gray-900'
          }`}
          role="menuitem"
        >
          {label}
        </a>
      ))}
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const button = document.getElementById('language-menu-button');
    const menu = document.getElementById('language-menu');

    if (button && menu) {
      button.addEventListener('click', (e) => {
        e.stopPropagation();
        menu.classList.toggle('hidden');
        const isExpanded = !menu.classList.contains('hidden');
        button.setAttribute('aria-expanded', isExpanded.toString());
      });

      // Close menu when clicking outside
      document.addEventListener('click', () => {
        menu.classList.add('hidden');
        button.setAttribute('aria-expanded', 'false');
      });

      // Prevent menu from closing when clicking inside
      menu.addEventListener('click', (e) => {
        e.stopPropagation();
      });
    }
  });
</script>
