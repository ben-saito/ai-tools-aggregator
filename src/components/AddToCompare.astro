---
interface Props {
  toolId: string;
}

const { toolId } = Astro.props;
---

<label class="group relative z-10 flex cursor-pointer items-center" onclick="event.stopPropagation()">
  <input 
    type="checkbox" 
    class="peer h-4 w-4 rounded border-gray-300 text-primary-600 focus:ring-primary-500"
    data-comparison-checkbox
    data-tool-id={toolId}
  />
  <span class="ml-2 text-sm text-gray-500 peer-checked:text-primary-600 group-hover:text-gray-700">Compare</span>
</label>

<script>
  import { selectedToolsMap, toggleTool, MAX_SELECTION } from '../stores/comparisonStore';

  // Find all checkboxes
  const checkboxes = document.querySelectorAll('[data-comparison-checkbox]') as NodeListOf<HTMLInputElement>;

  // Initialize state
  selectedToolsMap.subscribe(tools => {
    const selectedCount = Object.keys(tools).length;
    checkboxes.forEach(cb => {
      const toolId = cb.dataset.toolId;
      if (toolId) {
        cb.checked = !!tools[toolId];
        // Disable unselected checkboxes if max reached
        if (!tools[toolId] && selectedCount >= MAX_SELECTION) {
          cb.disabled = true;
          cb.parentElement?.classList.add('opacity-50', 'cursor-not-allowed');
        } else {
          cb.disabled = false;
          cb.parentElement?.classList.remove('opacity-50', 'cursor-not-allowed');
        }
      }
    });
  });

  // Handle changes
  checkboxes.forEach(cb => {
    cb.addEventListener('change', (e) => {
      e.stopPropagation(); // Stop propagation to prevent card click
      const toolId = cb.dataset.toolId;
      if (toolId) {
        // Toggle tool
        // Logic handled in store, but here we can check limits before calling store if needed?
        // Actually store handles logic.
        // But store logic is `toggleTool`.
        // Let's import toggleTool.
        const tools = selectedToolsMap.get();
        const isSelected = !!tools[toolId];
        const count = Object.keys(tools).length;
        
        if (!isSelected && count >= MAX_SELECTION) {
          alert(`You can only compare up to ${MAX_SELECTION} tools at a time.`);
          cb.checked = false; // Revert
          return;
        }

        if (isSelected) {
            selectedToolsMap.setKey(toolId, undefined!);
        } else {
            selectedToolsMap.setKey(toolId, 'true');
        }
      }
    });
    
    // Prevent click on label from bubbling to card link
    cb.addEventListener('click', (e) => {
      e.stopPropagation();
    });
  });
</script>
