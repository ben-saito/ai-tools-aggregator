---
import { categories } from '../lib/tools';
import { getLangFromUrl, languages } from '../lib/i18n';
import AuthButton from './AuthButton.astro';
import MobileNav from './MobileNav.astro';

const lang = getLangFromUrl(Astro.url);
const currentPath = Astro.url.pathname;
---

<header class="sticky top-0 z-40 border-b border-gray-200 bg-white shadow-sm">
  <nav class="mx-auto flex max-w-7xl items-center justify-between px-4 py-3 sm:py-4">
    <a href="/" class="flex items-center gap-2">
      <img src="/logo.png" alt="AI Tools Hub" class="h-8 w-8" />
      <span class="text-lg font-bold text-primary-600 sm:text-xl">AI Tools Hub</span>
    </a>
    
    <!-- Desktop Navigation -->
    <div class="hidden items-center gap-4 lg:flex lg:gap-6">
      <a href="/" class="text-gray-600 hover:text-primary-600">Home</a>
      <a href="/search" class="text-gray-600 hover:text-primary-600">Search</a>
      <a href="/rankings" class="text-gray-600 hover:text-primary-600">Rankings</a>
      <div class="group relative">
        <button class="flex items-center gap-1 text-gray-600 hover:text-primary-600">
          Categories
          <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
          </svg>
        </button>
        <div class="invisible absolute right-0 mt-2 w-64 rounded-lg border border-gray-200 bg-white py-2 shadow-lg group-hover:visible z-50">
          {categories.map((category) => (
            <a
              href={`/categories/${category.slug}`}
              class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50"
            >
              <span class="mr-2">{category.icon}</span>
              {category.name}
            </a>
          ))}
        </div>
      </div>
      <a href="/submit" class="rounded-lg bg-primary-600 px-4 py-2 text-sm font-semibold text-white hover:bg-primary-700">
        Submit Tool
      </a>
      <a href="/favorites" class="text-gray-600 hover:text-primary-600">Favorites</a>
      <a href="/about" class="text-gray-600 hover:text-primary-600">About</a>
      
      <!-- Language Switcher -->
      <div class="flex items-center gap-1 rounded-lg border border-gray-300 bg-white">
        <a 
          href={lang === 'ja' ? currentPath.replace('/ja', '') : currentPath}
          class={`px-3 py-1 text-sm font-medium transition ${lang === 'en' ? 'bg-primary-600 text-white rounded-lg' : 'text-gray-600 hover:text-primary-600'}`}
          data-lang="en"
        >
          EN
        </a>
        <a 
          href={lang === 'ja' ? currentPath : `/ja${currentPath}`}
          class={`px-3 py-1 text-sm font-medium transition ${lang === 'ja' ? 'bg-primary-600 text-white rounded-lg' : 'text-gray-600 hover:text-primary-600'}`}
          data-lang="ja"
        >
          JA
        </a>
      </div>
      
      <AuthButton />
    </div>
    
    <!-- Mobile Navigation Button -->
    <MobileNav />
  </nav>
</header>

<script>
  // Store and apply language preference
  document.addEventListener('DOMContentLoaded', () => {
    // Store language when clicking language links
    document.querySelectorAll('a[data-lang]').forEach(link => {
      link.addEventListener('click', (e) => {
        const lang = link.getAttribute('data-lang');
        localStorage.setItem('preferred-lang', lang);
      });
    });

    // Auto-redirect to preferred language on page load (only on homepage or if language doesn't match)
    const preferredLang = localStorage.getItem('preferred-lang');
    const currentPath = window.location.pathname;
    const isJaPath = currentPath.startsWith('/ja');
    const currentLang = isJaPath ? 'ja' : 'en';

    if (preferredLang && preferredLang !== currentLang) {
      // Construct the target URL
      let targetPath = currentPath;
      if (preferredLang === 'ja' && !isJaPath) {
        targetPath = '/ja' + currentPath;
      } else if (preferredLang === 'en' && isJaPath) {
        targetPath = currentPath.replace('/ja', '');
      }
      
      // Only redirect if the path actually changed
      if (targetPath !== currentPath) {
        window.location.href = targetPath;
      }
    }
  });
</script>
