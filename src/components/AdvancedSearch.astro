---
// Advanced Search Component with Filters
---

<div class="mb-8 rounded-xl border border-[var(--color-border-primary)] bg-[var(--color-bg-elevated)] p-6 shadow-[var(--shadow-card)]">
  <div class="mb-4">
    <label for="search-input" class="block text-sm font-medium text-[var(--color-text-secondary)] mb-2">
      AIツールを検索
    </label>
    <div class="relative">
      <input
        type="text"
        id="search-input"
        placeholder="ツール名、説明、カテゴリで検索..."
        class="w-full rounded-xl border border-[var(--color-border-primary)] bg-[var(--color-bg-primary)] text-[var(--color-text-primary)] pl-10 pr-4 py-3 transition-all focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500/20"
      />
      <svg
        class="absolute left-3 top-3.5 h-5 w-5 text-[var(--color-text-tertiary)]"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
        ></path>
      </svg>
    </div>
  </div>

  <!-- Filters -->
  <div class="grid gap-4 md:grid-cols-3">
    <!-- Category Filter -->
    <div>
      <label for="category-filter" class="block text-sm font-medium text-[var(--color-text-secondary)] mb-2">
        カテゴリ
      </label>
      <select
        id="category-filter"
        class="w-full rounded-lg border border-[var(--color-border-primary)] bg-[var(--color-bg-primary)] text-[var(--color-text-primary)] px-3 py-2 focus:border-primary-500 focus:outline-none"
      >
        <option value="">すべてのカテゴリ</option>
        <option value="text-generation">テキスト生成</option>
        <option value="image-generation">画像生成</option>
        <option value="video-generation">動画生成</option>
        <option value="audio-music">音声・音楽</option>
        <option value="code-development">コード開発</option>
        <option value="marketing-sales">マーケティング・営業</option>
        <option value="productivity">生産性向上</option>
        <option value="research-education">リサーチ・教育</option>
        <option value="design-creative">デザイン・クリエイティブ</option>
        <option value="data-analytics">データ・分析</option>
      </select>
    </div>

    <!-- Pricing Filter -->
    <div>
      <label for="pricing-filter" class="block text-sm font-medium text-[var(--color-text-secondary)] mb-2">
        料金プラン
      </label>
      <select
        id="pricing-filter"
        class="w-full rounded-lg border border-[var(--color-border-primary)] bg-[var(--color-bg-primary)] text-[var(--color-text-primary)] px-3 py-2 focus:border-primary-500 focus:outline-none"
      >
        <option value="">すべての料金</option>
        <option value="free">無料</option>
        <option value="freemium">フリーミアム</option>
        <option value="paid">有料</option>
        <option value="open-source">オープンソース</option>
      </select>
    </div>

    <!-- Sort -->
    <div>
      <label for="sort-by" class="block text-sm font-medium text-[var(--color-text-secondary)] mb-2">
        並び替え
      </label>
      <select
        id="sort-by"
        class="w-full rounded-lg border border-[var(--color-border-primary)] bg-[var(--color-bg-primary)] text-[var(--color-text-primary)] px-3 py-2 focus:border-primary-500 focus:outline-none"
      >
        <option value="newest">新着順</option>
        <option value="name">名前 (A-Z)</option>
        <option value="featured">おすすめ順</option>
      </select>
    </div>
  </div>

  <!-- Active Tag Filter -->
  <div id="active-tag-container" class="mt-4 hidden">
    <div class="flex items-center gap-2">
      <span class="text-sm text-[var(--color-text-secondary)]">タグ:</span>
      <span id="active-tag" class="inline-flex items-center gap-1 rounded-full bg-primary-100 px-3 py-1 text-sm font-medium text-primary-700"></span>
      <button
        id="clear-tag"
        class="text-sm text-[var(--color-text-secondary)] transition-colors hover:text-[var(--color-text-primary)]"
      >
        クリア
      </button>
    </div>
  </div>

  <!-- Results Count -->
  <div class="mt-4 text-sm text-[var(--color-text-secondary)]">
    <span id="results-count">読み込み中...</span>
  </div>
</div>

<!-- Results Container -->
<div id="search-results" class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3">
  <div class="col-span-full text-center py-8">
    <div class="inline-block h-8 w-8 animate-spin rounded-full border-4 border-[var(--color-border-primary)] border-t-primary-600"></div>
    <p class="mt-2 text-[var(--color-text-secondary)]">ツールを読み込み中...</p>
  </div>
</div>

<script is:inline>
  (function() {
    var supabaseUrl = 'https://mqksqezqbauqymftrydy.supabase.co';
    var supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1xa3NxZXpxYmF1cXltZnRyeWR5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2ODIwMDIsImV4cCI6MjA4NjI1ODAwMn0.Bf6nGo9I0skJWwFnXHHAKOBSBepYx7G8OHLw3Ih_Ytw';
    var apiBase = supabaseUrl + '/rest/v1';
    var headers = {
      'apikey': supabaseAnonKey,
      'Authorization': 'Bearer ' + supabaseAnonKey,
      'Content-Type': 'application/json'
    };

    var searchInput = document.getElementById('search-input');
    var categoryFilter = document.getElementById('category-filter');
    var pricingFilter = document.getElementById('pricing-filter');
    var sortBy = document.getElementById('sort-by');
    var resultsContainer = document.getElementById('search-results');
    var resultsCount = document.getElementById('results-count');
    var activeTagContainer = document.getElementById('active-tag-container');
    var activeTagSpan = document.getElementById('active-tag');
    var clearTagBtn = document.getElementById('clear-tag');

    var urlParams = new URLSearchParams(window.location.search);
    var tagFilter = urlParams.get('tag');

    if (tagFilter && activeTagContainer && activeTagSpan) {
      activeTagContainer.classList.remove('hidden');
      activeTagSpan.textContent = tagFilter;
    }

    if (clearTagBtn) {
      clearTagBtn.addEventListener('click', function() {
        var url = new URL(window.location.href);
        url.searchParams.delete('tag');
        window.location.href = url.toString();
      });
    }

    var debounceTimer;

    function buildQueryUrl() {
      var query = searchInput ? searchInput.value.trim() : '';
      var category = categoryFilter ? categoryFilter.value : '';
      var pricing = pricingFilter ? pricingFilter.value : '';
      var sort = sortBy ? sortBy.value : 'newest';

      var params = ['select=*', 'limit=50'];

      // テキスト検索: nameとdescriptionでilike検索
      if (query) {
        var encoded = encodeURIComponent('%' + query + '%');
        params.push('or=(name.ilike.' + encoded + ',description.ilike.' + encoded + ')');
      }

      // カテゴリフィルター
      if (category) {
        params.push('category=eq.' + encodeURIComponent(category));
      }

      // 料金フィルター
      if (pricing) {
        params.push('pricing=eq.' + encodeURIComponent(pricing));
      }

      // ソート
      if (sort === 'name') {
        params.push('order=name.asc');
      } else if (sort === 'featured') {
        params.push('order=featured.desc,created_at.desc');
      } else {
        // newest (default)
        params.push('order=created_at.desc');
      }

      return apiBase + '/tools?' + params.join('&');
    }

    function renderTool(tool) {
      var logoHtml = tool.logo_url
        ? '<img src="' + tool.logo_url + '" alt="' + (tool.name || '') + '" class="h-12 w-12 rounded-lg object-contain flex-shrink-0" onerror="this.style.display=\'none\'">'
        : '<div class="h-12 w-12 rounded-lg bg-[var(--color-bg-tertiary)] flex items-center justify-center flex-shrink-0"><span class="text-lg font-bold text-[var(--color-text-secondary)]">' + (tool.name || '?')[0] + '</span></div>';

      var category = (tool.category || '').replace(/-/g, ' ');
      var pricing = tool.pricing || '';
      var toolUrl = '/ja/tools/' + tool.id;

      return '<a href="' + toolUrl + '" class="group block rounded-xl border border-[var(--color-border-primary)] bg-[var(--color-bg-elevated)] p-6 shadow-[var(--shadow-card)] transition-all duration-200 hover:-translate-y-0.5 hover:border-primary-500 hover:shadow-[var(--shadow-card-hover)]">' +
        '<div class="flex items-start gap-4">' +
          logoHtml +
          '<div class="flex-1 min-w-0">' +
            '<h3 class="font-semibold text-[var(--color-text-primary)] group-hover:text-primary-600 transition-colors line-clamp-1">' + (tool.name || '') + '</h3>' +
            '<p class="mt-2 text-sm text-[var(--color-text-secondary)] line-clamp-2">' + (tool.description || '') + '</p>' +
            '<div class="mt-3 flex flex-wrap gap-2">' +
              (category ? '<span class="rounded-md bg-[var(--color-bg-tertiary)] px-2 py-1 text-xs text-[var(--color-text-secondary)]">' + category + '</span>' : '') +
              (pricing ? '<span class="rounded-md bg-primary-50 dark:bg-primary-900/30 px-2 py-1 text-xs text-primary-700 dark:text-primary-300">' + pricing + '</span>' : '') +
            '</div>' +
          '</div>' +
        '</div>' +
      '</a>';
    }

    async function searchTools() {
      if (!resultsContainer) return;

      resultsContainer.innerHTML =
        '<div class="col-span-full text-center py-8">' +
          '<div class="inline-block h-8 w-8 animate-spin rounded-full border-4 border-[var(--color-border-primary)] border-t-primary-600"></div>' +
          '<p class="mt-2 text-[var(--color-text-secondary)]">検索中...</p>' +
        '</div>';

      try {
        var url = buildQueryUrl();
        var response = await fetch(url, { headers: headers });

        if (!response.ok) {
          var errText = await response.text();
          throw new Error('API error: ' + response.status + ' - ' + errText);
        }

        var tools = await response.json();

        if (resultsCount) {
          resultsCount.textContent = tools.length + '件のツールが見つかりました';
        }

        if (!tools || tools.length === 0) {
          resultsContainer.innerHTML =
            '<div class="col-span-full text-center py-12">' +
              '<svg class="mx-auto h-12 w-12 text-[var(--color-text-tertiary)]" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
                '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>' +
              '</svg>' +
              '<h3 class="mt-4 text-sm font-medium text-[var(--color-text-primary)]">ツールが見つかりませんでした</h3>' +
              '<p class="mt-1 text-sm text-[var(--color-text-tertiary)]">検索条件を変えてみてください</p>' +
            '</div>';
        } else {
          resultsContainer.innerHTML = tools.map(renderTool).join('');
        }
      } catch (err) {
        console.error('Search error:', err);
        if (resultsContainer) {
          resultsContainer.innerHTML =
            '<div class="col-span-full text-center py-12">' +
              '<p class="text-red-500">エラーが発生しました: ' + err.message + '</p>' +
              '<button onclick="location.reload()" class="mt-4 px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700">再読み込み</button>' +
            '</div>';
        }
      }
    }

    function debouncedSearch() {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(searchTools, 300);
    }

    if (searchInput) searchInput.addEventListener('input', debouncedSearch);
    if (categoryFilter) categoryFilter.addEventListener('change', searchTools);
    if (pricingFilter) pricingFilter.addEventListener('change', searchTools);
    if (sortBy) sortBy.addEventListener('change', searchTools);

    // 初回ロード
    searchTools();
  })();
</script>

<style>
  .line-clamp-1 {
    display: -webkit-box;
    -webkit-line-clamp: 1;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
