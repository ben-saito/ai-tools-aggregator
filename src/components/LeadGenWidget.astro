---
import { supabase } from '../lib/supabase';

interface Props {
  toolId: string;
  toolName: string;
}

const { toolId, toolName } = Astro.props;
---

<div class="rounded-xl border border-primary-200 dark:border-primary-800 bg-primary-50 dark:bg-primary-900/20 p-6 shadow-[var(--shadow-card)]">
  <div class="flex items-center justify-between">
    <div>
      <h3 class="text-lg font-bold text-[var(--color-text-primary)]">Interested in {toolName} for your team?</h3>
      <p class="mt-1 text-sm text-[var(--color-text-secondary)]">Request a demo or contact sales directly.</p>
    </div>
    <button
      id="open-lead-modal"
      class="rounded-lg bg-primary-600 px-4 py-2 text-sm font-semibold text-white shadow-sm transition-colors hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2"
    >
      Request Demo
    </button>
  </div>
</div>

<!-- Modal -->
<dialog id="lead-modal" class="w-full max-w-md rounded-xl bg-[var(--color-bg-elevated)] p-0 backdrop:bg-gray-900/50">
  <div class="p-6">
    <div class="mb-4 flex items-center justify-between">
      <h3 class="text-xl font-bold text-[var(--color-text-primary)]">Request Demo for {toolName}</h3>
      <button id="close-lead-modal" class="text-[var(--color-text-tertiary)] hover:text-[var(--color-text-secondary)]">
        <span class="sr-only">Close</span>
        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>

    <form id="lead-form" class="space-y-4">
      <div>
        <label for="company_name" class="block text-sm font-medium text-[var(--color-text-secondary)]">Company Name</label>
        <input type="text" id="company_name" name="company_name" required class="mt-1 block w-full rounded-md border-[var(--color-border-primary)] bg-[var(--color-bg-primary)] text-[var(--color-text-primary)] shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm" />
      </div>

      <div>
        <label for="company_size" class="block text-sm font-medium text-[var(--color-text-secondary)]">Company Size</label>
        <select id="company_size" name="company_size" class="mt-1 block w-full rounded-md border-[var(--color-border-primary)] bg-[var(--color-bg-primary)] text-[var(--color-text-primary)] shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm">
          <option value="1-10">1-10 employees</option>
          <option value="11-50">11-50 employees</option>
          <option value="51-200">51-200 employees</option>
          <option value="201-500">201-500 employees</option>
          <option value="500+">500+ employees</option>
        </select>
      </div>

      <div>
        <label for="use_case" class="block text-sm font-medium text-[var(--color-text-secondary)]">Use Case / Notes</label>
        <textarea id="use_case" name="use_case" rows="3" class="mt-1 block w-full rounded-md border-[var(--color-border-primary)] bg-[var(--color-bg-primary)] text-[var(--color-text-primary)] shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm"></textarea>
      </div>

      <div id="lead-auth-error" class="hidden text-sm text-red-600">
        You must be logged in to request a demo.
      </div>

      <button type="submit" class="w-full justify-center rounded-md border border-transparent bg-primary-600 px-4 py-2 text-sm font-medium text-white shadow-sm transition-colors hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2">
        Submit Request
      </button>
    </form>
  </div>
</dialog>

<script define:vars={{ toolId }}>
  import { supabase } from '../lib/supabase';

  const openBtn = document.getElementById('open-lead-modal');
  const closeBtn = document.getElementById('close-lead-modal');
  const modal = document.getElementById('lead-modal');
  const form = document.getElementById('lead-form');
  const authError = document.getElementById('lead-auth-error');

  openBtn?.addEventListener('click', () => {
    modal?.showModal();
  });

  closeBtn?.addEventListener('click', () => {
    modal?.close();
  });

  // Close on click outside
  modal?.addEventListener('click', (e) => {
    const dialogDimensions = modal.getBoundingClientRect();
    if (
      e.clientX < dialogDimensions.left ||
      e.clientX > dialogDimensions.right ||
      e.clientY < dialogDimensions.top ||
      e.clientY > dialogDimensions.bottom
    ) {
      modal.close();
    }
  });

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(form);
    const companyName = formData.get('company_name');
    const companySize = formData.get('company_size');
    const useCase = formData.get('use_case');

    const { data: { session } } = await supabase.auth.getSession();

    if (!session) {
      authError?.classList.remove('hidden');
      // Ideally redirect to login or open login modal
      return;
    }

    try {
      const { error } = await supabase.from('leads').insert({
        tool_id: toolId,
        user_id: session.user.id,
        company_name: companyName,
        company_size: companySize,
        use_case: useCase,
        status: 'new'
      });

      if (error) throw error;

      alert('Request sent successfully!');
      modal?.close();
      form.reset();

    } catch (err) {
      console.error('Error submitting lead:', err);
      alert('Failed to submit request. Please try again.');
    }
  });
</script>
