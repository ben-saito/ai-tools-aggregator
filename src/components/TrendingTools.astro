---
import { getAllTools } from '../lib/tools';
const tools = getAllTools();
---

<div data-tools={JSON.stringify(tools)}>
  <section class="mb-12">
    <h2 class="mb-6 text-2xl font-bold text-[var(--color-text-primary)]">Trending Now</h2>
    <div id="trending-tools" class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
      <div class="col-span-full text-center py-8">
        <div class="inline-block h-6 w-6 animate-spin rounded-full border-4 border-[var(--color-border-primary)] border-t-primary-600"></div>
      </div>
    </div>
  </section>

  <section class="mb-12">
    <h2 class="mb-6 text-2xl font-bold text-[var(--color-text-primary)]">Top Rated Tools</h2>
    <div id="top-rated-tools" class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
      <div class="col-span-full text-center py-8">
        <div class="inline-block h-6 w-6 animate-spin rounded-full border-4 border-[var(--color-border-primary)] border-t-primary-600"></div>
      </div>
    </div>
  </section>
</div>

<script>
  (async function() {
    // Wait for Supabase to load
    while (!window.__supabaseReady && typeof window.supabase === 'undefined') {
      await new Promise(resolve => setTimeout(resolve, 50));
    }

    // Initialize Supabase
    const supabaseUrl = 'https://mqksqezqbauqymftrydy.supabase.co';
    const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1xa3NxZXpxYmF1cXltZnRyeWR5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2ODIwMDIsImV4cCI6MjA4NjI1ODAwMn0.Bf6nGo9I0skJWwFnXHHAKOBSBepYx7G8OHLw3Ih_Ytw';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);

  // Helper functions
  async function getTrendingTools(limit = 10) {
    const { data, error } = await supabase
      .from('tools_stats')
      .select('*')
      .order('trending_score', { ascending: false })
      .limit(limit);
    if (error) throw error;
    return data;
  }

  async function getTopRatedTools(limit = 10, minReviews = 3) {
    const { data, error } = await supabase
      .from('tools_stats')
      .select('*')
      .gte('review_count', minReviews)
      .gte('average_rating', 4.5)
      .order('average_rating', { ascending: false })
      .limit(limit);
    if (error) throw error;
    return data;
  }

  // Get tools data from data attribute
  function getAllTools() {
    const toolsContainer = document.querySelector('[data-tools]');
    if (!toolsContainer) return [];
    const toolsJson = toolsContainer.getAttribute('data-tools');
    return JSON.parse(toolsJson || '[]');
  }

  async function loadTrending() {
    try {
      const tools = getAllTools();
      const trending = await getTrendingTools(6);
      const container = document.getElementById('trending-tools');

      if (!container) return;

      if (trending.length === 0) {
        container.innerHTML = `
          <div class="col-span-full text-center py-8 text-[var(--color-text-secondary)]">
            No trending tools yet. Be the first to review!
          </div>
        `;
        return;
      }

      const trendingTools = trending
        .map(stat => ({
          ...stat,
          tool: tools.find(t => t.id === stat.tool_id)
        }))
        .filter(item => item.tool != null);

      container.innerHTML = trendingTools.map(item => `
        <a href="/tools/${item.tool.id}" class="group block rounded-xl border border-[var(--color-border-primary)] bg-[var(--color-bg-elevated)] p-6 shadow-[var(--shadow-card)] transition-all duration-200 hover:-translate-y-0.5 hover:border-primary-500 hover:shadow-[var(--shadow-card-hover)]">
          <div class="flex items-start gap-4">
            ${item.tool.logoUrl ? `
              <img src="${item.tool.logoUrl}" alt="${item.tool.name}" class="h-12 w-12 rounded-lg">
            ` : ''}
            <div class="flex-1 min-w-0">
              <h3 class="font-semibold text-[var(--color-text-primary)] group-hover:text-primary-600 transition-colors truncate">
                ${item.tool.name}
              </h3>
              <p class="mt-1 text-sm text-[var(--color-text-secondary)] line-clamp-2">${item.tool.description}</p>
              <div class="mt-3 flex items-center gap-3 text-sm">
                <div class="flex items-center gap-1">
                  <span class="text-yellow-400">&#11088;</span>
                  <span class="font-medium text-[var(--color-text-primary)]">${item.average_rating.toFixed(1)}</span>
                </div>
                <span class="text-[var(--color-text-tertiary)]">${item.review_count} reviews</span>
                <span class="text-orange-600 dark:text-orange-400 font-medium">
                  ${item.trending_score.toFixed(1)}
                </span>
              </div>
            </div>
          </div>
        </a>
      `).join('');
    } catch (error) {
      console.error('Error loading trending tools:', error);
      const container = document.getElementById('trending-tools');
      if (container) {
        container.innerHTML = `
          <div class="col-span-full text-center py-8 text-[var(--color-text-secondary)]">
            No trending data available yet.
          </div>
        `;
      }
    }
  }

  async function loadTopRated() {
    try {
      const tools = getAllTools();
      const topRated = await getTopRatedTools(6, 3); // Min 3 reviews
      const container = document.getElementById('top-rated-tools');

      if (!container) return;

      if (topRated.length === 0) {
        container.innerHTML = `
          <div class="col-span-full text-center py-8 text-[var(--color-text-secondary)]">
            No top-rated tools yet. Be the first to review!
          </div>
        `;
        return;
      }

      const topRatedTools = topRated
        .map(stat => ({
          ...stat,
          tool: tools.find(t => t.id === stat.tool_id)
        }))
        .filter(item => item.tool != null);

      container.innerHTML = topRatedTools.map(item => `
        <a href="/tools/${item.tool.id}" class="group block rounded-xl border border-[var(--color-border-primary)] bg-[var(--color-bg-elevated)] p-6 shadow-[var(--shadow-card)] transition-all duration-200 hover:-translate-y-0.5 hover:border-primary-500 hover:shadow-[var(--shadow-card-hover)]">
          <div class="flex items-start gap-4">
            ${item.tool.logoUrl ? `
              <img src="${item.tool.logoUrl}" alt="${item.tool.name}" class="h-12 w-12 rounded-lg">
            ` : ''}
            <div class="flex-1 min-w-0">
              <h3 class="font-semibold text-[var(--color-text-primary)] group-hover:text-primary-600 transition-colors truncate">
                ${item.tool.name}
              </h3>
              <p class="mt-1 text-sm text-[var(--color-text-secondary)] line-clamp-2">${item.tool.description}</p>
              <div class="mt-3 flex items-center gap-3 text-sm">
                <div class="flex items-center gap-1">
                  <span class="text-yellow-400">&#11088;</span>
                  <span class="font-medium text-[var(--color-text-primary)]">${item.average_rating.toFixed(1)}</span>
                </div>
                <span class="text-[var(--color-text-tertiary)]">${item.review_count} reviews</span>
              </div>
            </div>
          </div>
        </a>
      `).join('');
    } catch (error) {
      console.error('Error loading top rated tools:', error);
      const container = document.getElementById('top-rated-tools');
      if (container) {
        container.innerHTML = `
          <div class="col-span-full text-center py-8 text-[var(--color-text-secondary)]">
            No top-rated data available yet.
          </div>
        `;
      }
    }
  }

    // Load on page load
    loadTrending();
    loadTopRated();
  })();
</script>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
