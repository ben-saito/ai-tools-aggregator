---
// Advanced Search Component with Filters
---

<div class="mb-8 rounded-lg border border-gray-200 bg-white p-6">
  <div class="mb-4">
    <label for="search-input" class="block text-sm font-medium text-gray-700 mb-2">
      Search AI Tools
    </label>
    <div class="relative">
      <input
        type="text"
        id="search-input"
        placeholder="Search by name, description, or category..."
        class="w-full rounded-lg border border-gray-300 pl-10 pr-4 py-3 focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500"
      />
      <svg
        class="absolute left-3 top-3.5 h-5 w-5 text-gray-400"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
        ></path>
      </svg>
    </div>
  </div>

  <!-- Filters -->
  <div class="grid gap-4 md:grid-cols-3">
    <!-- Category Filter -->
    <div>
      <label for="category-filter" class="block text-sm font-medium text-gray-700 mb-2">
        Category
      </label>
      <select
        id="category-filter"
        class="w-full rounded-lg border border-gray-300 px-3 py-2 focus:border-primary-500 focus:outline-none"
      >
        <option value="">All Categories</option>
        <option value="text-generation">Text Generation</option>
        <option value="image-generation">Image Generation</option>
        <option value="video-generation">Video Generation</option>
        <option value="audio-music">Audio & Music</option>
        <option value="code-development">Code Development</option>
        <option value="marketing-sales">Marketing & Sales</option>
        <option value="productivity">Productivity</option>
        <option value="research-education">Research & Education</option>
        <option value="design-creative">Design & Creative</option>
        <option value="data-analytics">Data & Analytics</option>
      </select>
    </div>

    <!-- Pricing Filter -->
    <div>
      <label for="pricing-filter" class="block text-sm font-medium text-gray-700 mb-2">
        Pricing
      </label>
      <select
        id="pricing-filter"
        class="w-full rounded-lg border border-gray-300 px-3 py-2 focus:border-primary-500 focus:outline-none"
      >
        <option value="">All Pricing</option>
        <option value="free">Free</option>
        <option value="freemium">Freemium</option>
        <option value="paid">Paid</option>
        <option value="open-source">Open Source</option>
      </select>
    </div>

    <!-- Sort -->
    <div>
      <label for="sort-by" class="block text-sm font-medium text-gray-700 mb-2">
        Sort By
      </label>
      <select
        id="sort-by"
        class="w-full rounded-lg border border-gray-300 px-3 py-2 focus:border-primary-500 focus:outline-none"
      >
        <option value="trending">Trending</option>
        <option value="rating">Highest Rated</option>
        <option value="reviews">Most Reviewed</option>
        <option value="newest">Newest</option>
        <option value="name">Name (A-Z)</option>
      </select>
    </div>
  </div>

  <!-- Results Count -->
  <div class="mt-4 text-sm text-gray-600">
    <span id="results-count">Loading...</span>
  </div>
</div>

<!-- Results Container -->
<div id="search-results" class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3">
  <div class="col-span-full text-center py-8">
    <div class="inline-block h-8 w-8 animate-spin rounded-full border-4 border-gray-200 border-t-blue-600"></div>
    <p class="mt-2 text-gray-600">Loading tools...</p>
  </div>
</div>

<script>
  (async function() {
    // Wait for Supabase to load
    while (!window.__supabaseReady && typeof window.supabase === 'undefined') {
      await new Promise(resolve => setTimeout(resolve, 50));
    }

    const supabaseUrl = 'https://mqksqezqbauqymftrydy.supabase.co';
    const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1xa3NxZXpxYmF1cXltZnRyeWR5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2ODIwMDIsImV4cCI6MjA4NjI1ODAwMn0.Bf6nGo9I0skJWwFnXHHAKOBSBepYx7G8OHLw3Ih_Ytw';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);

    const searchInput = document.getElementById('search-input');
    const categoryFilter = document.getElementById('category-filter');
    const pricingFilter = document.getElementById('pricing-filter');
    const sortBy = document.getElementById('sort-by');
    const resultsContainer = document.getElementById('search-results');
    const resultsCount = document.getElementById('results-count');

    let debounceTimer;

    async function searchTools() {
      const query = searchInput.value.trim();
      const category = categoryFilter.value;
      const pricing = pricingFilter.value;
      const sort = sortBy.value;

      // Show loading
      resultsContainer.innerHTML = `
        <div class="col-span-full text-center py-8">
          <div class="inline-block h-8 w-8 animate-spin rounded-full border-4 border-gray-200 border-t-blue-600"></div>
          <p class="mt-2 text-gray-600">Searching...</p>
        </div>
      `;

      try {
        let dbQuery = supabase
          .from('tools')
          .select('*');

        // Apply full-text search if query exists
        if (query) {
          dbQuery = dbQuery.textSearch('search_vector', query);
        }

        // Apply filters
        if (category) {
          dbQuery = dbQuery.eq('category', category);
        }

        if (pricing) {
          dbQuery = dbQuery.eq('pricing', pricing);
        }

        // Apply sorting
        switch (sort) {
          case 'rating':
            // Join with tools_stats for rating
            dbQuery = dbQuery.order('average_rating', { ascending: false });
            break;
          case 'reviews':
            dbQuery = dbQuery.order('review_count', { ascending: false });
            break;
          case 'newest':
            dbQuery = dbQuery.order('created_at', { ascending: false });
            break;
          case 'name':
            dbQuery = dbQuery.order('name', { ascending: true });
            break;
          case 'trending':
          default:
            dbQuery = dbQuery.order('trending_score', { ascending: false });
        }

        const { data: tools, error } = await dbQuery.limit(50);

        if (error) throw error;

        // Update results count
        resultsCount.textContent = `${tools.length} tools found`;

        // Render results
        if (tools.length === 0) {
          resultsContainer.innerHTML = `
            <div class="col-span-full text-center py-12">
              <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M12 12h.01M12 12h.01M12 12h.01"></path>
              </svg>
              <h3 class="mt-2 text-sm font-medium text-gray-900">No tools found</h3>
              <p class="mt-1 text-sm text-gray-500">Try adjusting your search or filters</p>
            </div>
          `;
        } else {
          resultsContainer.innerHTML = tools.map(tool => `
            <a href="/tools/${tool.id}" class="group block rounded-lg border border-gray-200 bg-white p-6 hover:border-primary-500 hover:shadow-lg transition-all">
              <div class="flex items-start gap-4">
                ${tool.logo_url ? `<img src="${tool.logo_url}" alt="${tool.name}" class="h-12 w-12 rounded-lg">` : ''}
                <div class="flex-1 min-w-0">
                  <h3 class="font-semibold text-gray-900 group-hover:text-primary-600 transition-colors line-clamp-1">
                    ${tool.name}
                  </h3>
                  <p class="mt-2 text-sm text-gray-600 line-clamp-2">
                    ${tool.description}
                  </p>
                  <div class="mt-3 flex gap-2">
                    <span class="rounded bg-gray-100 px-2 py-1 text-xs text-gray-700">
                      ${tool.category.replace('-', ' ')}
                    </span>
                    <span class="rounded bg-primary-50 px-2 py-1 text-xs text-primary-700">
                      ${tool.pricing}
                    </span>
                  </div>
                </div>
              </div>
            </a>
          `).join('');
        }

      } catch (error) {
        console.error('Search error:', error);
        resultsContainer.innerHTML = `
          <div class="col-span-full text-center py-12">
            <p class="text-red-600">Error loading tools. Please try again.</p>
          </div>
        `;
      }
    }

    // Debounced search
    function debouncedSearch() {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(searchTools, 300);
    }

    // Event listeners
    searchInput?.addEventListener('input', debouncedSearch);
    categoryFilter?.addEventListener('change', searchTools);
    pricingFilter?.addEventListener('change', searchTools);
    sortBy?.addEventListener('change', searchTools);

    // Initial load
    searchTools();
  })();
</script>

<style>
  .line-clamp-1 {
    display: -webkit-box;
    -webkit-line-clamp: 1;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
